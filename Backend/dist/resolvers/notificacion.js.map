{"version":3,"sources":["../../resolvers/notificacion.js"],"names":["Query","getNumeroNotificacionUsuario","parent","args","models","User","findOne","_id","id","populate","path","match","leido","tipo","then","listaNotificaciones","length","catch","error","loadListaNotificacionesUsuario","model","loadListaNotificacionesMasRecientesNoLeidas","find","options","sort","fecha_creacion","limit","ArrayNotificaciones","Error","Mutation","crearNotificacionUsuario","findById","idEmisor","notificacionSchema","usuario_emisor","usuario","descripcion","notificacion","Notificacion","save","findByIdAndUpdate","idReceptor","$push","document","upsert","errorActualizacion","setAllNotificacionesLikeLeida","arrayNotificaciones","item","next","$set","setNotificacionLeida","update","idNotificacion","new","documento"],"mappings":";;;;;;AAAA;;;;;;kBAEe;AACdA,QAAM;AACLC,gCAA8B,sCAACC,MAAD,EAASC,IAAT,QAA0B;AAAA,OAAVC,MAAU,QAAVA,MAAU;;AACvDA,UAAOC,IAAP,CAAYC,OAAZ,CAAoB,EAACC,KAAIJ,KAAKK,EAAV,EAApB,EAAmC,gBAAnC,EACEC,QADF,CACW;AACTC,UAAK,gBADI;AAETC,WAAM;AACLC,YAAO,KADF,EACSC,MAAMV,KAAKU;AADpB;AAFG,IADX,EAOEC,IAPF,CAOO,+BAAqB;AAC1B,WAAOC,oBAAoBC,MAA3B;AACA,IATF,EAUEC,KAVF,CAUQ,iBAAS;AACf,QAAIC,KAAJ,EAAU;AACT,YAAO,CAAP;AACA;AAED,IAfF;AAgBA,GAlBI;AAmBLC,kCAAgC,wCAACjB,MAAD,EAASC,IAAT,SAA0B;AAAA,OAAVC,MAAU,SAAVA,MAAU;;AACzDA,UAAOC,IAAP,CAAYC,OAAZ,CAAoB,EAACC,KAAKJ,KAAKK,EAAX,EAApB,EAAoC,gBAApC,EACEC,QADF,CACW,EAACC,MAAK,gBAAN;AACTC,WAAM,EAACE,MAAMV,KAAKU,IAAZ,EADG;AAETJ,cAAU;AACTC,WAAM,gBADG;AAETU,YAAM;AAFG,KAFD,EADX,EAOEN,IAPF,CAOO,+BAAqB;AAC1B,WAAOC,mBAAP;AACA,IATF,EAUEE,KAVF,CAUQ,iBAAO;AACb,QAAIC,KAAJ,EAAU;AACT,YAAO,IAAP;AACA;AAED,IAfF;AAgBA,GApCI;AAqCLG,+CAA6C,qDAACnB,MAAD,EAASC,IAAT,SAA0B;AAAA,OAAVC,MAAU,SAAVA,MAAU;;AACtEA,UAAOC,IAAP,CAAYiB,IAAZ,CAAiB,EAACf,KAAKJ,KAAKK,EAAX,EAAjB,EAAgC,gBAAhC,EACEC,QADF,CACW,EAACC,MAAK,gBAAN;AACTC,WAAM,EAACC,OAAO,KAAR,EAAeC,MAAMV,KAAKU,IAA1B,EADG;AAETU,aAAQ;AACPC,WAAK;AACJC,sBAAgB;AADZ,MADE;AAIPC,YAAM,EAJC,EAFC;AAOTjB,cAAU;AACTC,WAAM,gBADG;AAETU,YAAM;AAFG,KAPD,EADX,EAYEN,IAZF,CAYO,+BAAqB;AAC1B,WAAOa,mBAAP;AAEA,IAfF,EAgBEV,KAhBF,CAgBQ,iBAAS;AACf,QAAIW,KAAJ,EAAU;AACT,YAAO,IAAP;AACA;AAED,IArBF;AAwBA;AA9DI,EADQ;AAiEdC,WAAS;AACRC,4BAAyB,kCAAC5B,MAAD,EAASC,IAAT,SAA0B;AAAA,OAAVC,MAAU,SAAVA,MAAU;;AAClDA,UAAOC,IAAP,CAAY0B,QAAZ,CAAqB5B,KAAK6B,QAA1B,EACElB,IADF,CACO,mBAAS;AACd,QAAImB,qBAAqB;AACxBC,qBAAiBC,QAAQ5B,GADD;AAExBM,WAAMsB,QAAQtB,IAFU;AAGxBuB,kBAAaD,QAAQC;AAHG,KAAzB;AAKA,QAAIC,eAAe,IAAIjC,OAAOkC,YAAX,CAAwBL,kBAAxB,CAAnB;AACAI,iBAAaE,IAAb,GACEzB,IADF,CACO,oBAAY;AACjBV,YAAOC,IAAP,CAAYmC,iBAAZ,CAA8BrC,KAAKsC,UAAnC,EAA8C;AAC7CC,aAAM;AACL,yBAAiBC;AADZ;AADuC,MAA9C,EAIE;AACDC,cAAQ;AADP,MAJF,EAMG9B,IANH,CAMQ,YAAM;AACb,aAAO6B,QAAP;AACA,MARD,EAQG1B,KARH,CAQS,8BAAsB;AAC9B,aAAO4B,kBAAP;AACA,MAVD;AAWA,KAbF,EAcE5B,KAdF,CAcQ,YAAM;AACZ,YAAO,IAAP;AACA,KAhBF;AAiBA,IAzBF,EA0BEA,KA1BF,CA0BQ,YAAM;AACZ,WAAO,IAAP;AACA,IA5BF;AA8BA,GAhCO;AAiCR6B,iCAA+B,uCAAC5C,MAAD,EAASC,IAAT,SAA0B;AAAA,OAAVC,MAAU,SAAVA,MAAU;;AACxDA,UAAOC,IAAP,CAAY0B,QAAZ,CAAqB5B,KAAKK,EAA1B,EAA6B,gBAA7B,EACEC,QADF,CACW;AACTC,UAAM,gBADG;AAETC,WAAO;AACNE,WAAMV,KAAKU,IADL;AAEND,YAAO;AAFD;AAFE,IADX,EAQEE,IARF,CAQO,+BAAqB;AAC1B,iCAAUiC,mBAAV,EAA+B,UAACC,IAAD,EAAOC,IAAP,EAAe;AAC7C7C,YAAOkC,YAAP,CAAoBE,iBAApB,CAAsCQ,KAAKzC,GAA3C,EAAgD;AAC/C2C,YAAK,EAACtC,OAAO,IAAR;AAD0C,MAAhD;AAGAqC;AACA,KALD,EAKE,UAAC/B,KAAD,EAAS;AACV,SAAIA,KAAJ,EAAU;AACT,aAAO,KAAP;AACA;AACD,KATD;AAUA,IAnBF,EAoBED,KApBF,CAoBQ,iBAAS;AACf,QAAIW,KAAJ,EAAU;AACT,YAAO,KAAP;AACA;AACD,IAxBF;AAyBA,GA3DO;AA4DRuB,wBAAsB,8BAACjD,MAAD,EAASC,IAAT,SAA0B;AAAA,OAAVC,MAAU,SAAVA,MAAU;;AAC/CA,UAAOkC,YAAP,CAAoBc,MAApB,CAA2B,EAAC7C,KAAKJ,KAAKkD,cAAX,EAA2BxC,MAAMV,KAAKU,IAAtC,EAA3B,EAAuE,EAACqC,MAAM,EAACtC,OAAO,IAAR,EAAP,EAAvE,EAA6F,EAACgC,QAAQ,IAAT,EAAeU,KAAK,IAApB,EAA7F,EACExC,IADF,CACO;AAAA,WAAayC,SAAb;AAAA,IADP,EAEEtC,KAFF,CAEQ;AAAA,WAASC,KAAT;AAAA,IAFR;AAGA;AAhEO;AAjEK,C","file":"notificacion.js","sourcesContent":["import asyncloop from \"node-async-loop\";\n\nexport default {\n\tQuery:{\n\t\tgetNumeroNotificacionUsuario: (parent, args, {models})=>{\n\t\t\tmodels.User.findOne({_id:args.id}, \"notificaciones\")\n\t\t\t\t.populate({\n\t\t\t\t\tpath:\"notificaciones\",\n\t\t\t\t\tmatch:{\n\t\t\t\t\t\tleido: false, tipo: args.tipo\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.then(listaNotificaciones=>{\n\t\t\t\t\treturn listaNotificaciones.length;\n\t\t\t\t})\n\t\t\t\t.catch(error => {\n\t\t\t\t\tif (error){\n\t\t\t\t\t\treturn 0;\n\t\t\t\t\t}\n\n\t\t\t\t});\n\t\t},\n\t\tloadListaNotificacionesUsuario: (parent, args, {models})=>{\n\t\t\tmodels.User.findOne({_id: args.id}, \"notificaciones\")\n\t\t\t\t.populate({path:\"notificaciones\",\n\t\t\t\t\tmatch:{tipo: args.tipo},\n\t\t\t\t\tpopulate: {\n\t\t\t\t\t\tpath: \"usuario_emisor\",\n\t\t\t\t\t\tmodel:\"usuario\"\n\t\t\t\t\t}})\n\t\t\t\t.then(listaNotificaciones=>{\n\t\t\t\t\treturn listaNotificaciones;\n\t\t\t\t})\n\t\t\t\t.catch(error=>{\n\t\t\t\t\tif (error){\n\t\t\t\t\t\treturn null;\n\t\t\t\t\t}\n\n\t\t\t\t});\n\t\t},\n\t\tloadListaNotificacionesMasRecientesNoLeidas: (parent, args, {models})=>{\n\t\t\tmodels.User.find({_id: args.id},\"notificaciones\")\n\t\t\t\t.populate({path:\"notificaciones\",\n\t\t\t\t\tmatch:{leido: false, tipo: args.tipo},\n\t\t\t\t\toptions:{\n\t\t\t\t\t\tsort:{\n\t\t\t\t\t\t\tfecha_creacion: \"asc\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\tlimit:10},\n\t\t\t\t\tpopulate: {\n\t\t\t\t\t\tpath: \"usuario_emisor\",\n\t\t\t\t\t\tmodel:\"usuario\"\n\t\t\t\t\t}})\n\t\t\t\t.then(ArrayNotificaciones=>{\n\t\t\t\t\treturn ArrayNotificaciones;\n\n\t\t\t\t})\n\t\t\t\t.catch(Error => {\n\t\t\t\t\tif (Error){\n\t\t\t\t\t\treturn null;\n\t\t\t\t\t}\n\n\t\t\t\t});\n\n\n\t\t}\n\t},\n\tMutation:{\n\t\tcrearNotificacionUsuario:(parent, args, {models})=>{\n\t\t\tmodels.User.findById(args.idEmisor)\n\t\t\t\t.then(usuario=>{\n\t\t\t\t\tlet notificacionSchema = {\n\t\t\t\t\t\tusuario_emisor : usuario._id,\n\t\t\t\t\t\ttipo: usuario.tipo,\n\t\t\t\t\t\tdescripcion: usuario.descripcion\n\t\t\t\t\t};\n\t\t\t\t\tlet notificacion = new models.Notificacion(notificacionSchema);\n\t\t\t\t\tnotificacion.save()\n\t\t\t\t\t\t.then(document => {\n\t\t\t\t\t\t\tmodels.User.findByIdAndUpdate(args.idReceptor,{\n\t\t\t\t\t\t\t\t$push:{\n\t\t\t\t\t\t\t\t\t\"notificaciones\":document\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t},{\n\t\t\t\t\t\t\t\tupsert: true\n\t\t\t\t\t\t\t}).then(() => {\n\t\t\t\t\t\t\t\treturn document;\n\t\t\t\t\t\t\t}).catch(errorActualizacion => {\n\t\t\t\t\t\t\t\treturn errorActualizacion;\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.catch(() => {\n\t\t\t\t\t\t\treturn null;\n\t\t\t\t\t\t});\n\t\t\t\t})\n\t\t\t\t.catch(() => {\n\t\t\t\t\treturn null;\n\t\t\t\t});\n\n\t\t},\n\t\tsetAllNotificacionesLikeLeida: (parent, args, {models})=>{\n\t\t\tmodels.User.findById(args.id,\"notificaciones\")\n\t\t\t\t.populate({\n\t\t\t\t\tpath: \"notificaciones\",\n\t\t\t\t\tmatch: {\n\t\t\t\t\t\ttipo: args.tipo,\n\t\t\t\t\t\tleido: false\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.then(arrayNotificaciones=>{\n\t\t\t\t\tasyncloop(arrayNotificaciones, (item, next) =>{\n\t\t\t\t\t\tmodels.Notificacion.findByIdAndUpdate(item._id, {\n\t\t\t\t\t\t\t$set:{leido: true}\n\t\t\t\t\t\t});\n\t\t\t\t\t\tnext();\n\t\t\t\t\t},(error)=>{\n\t\t\t\t\t\tif (error){\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t})\n\t\t\t\t.catch(Error => {\n\t\t\t\t\tif (Error){\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t},\n\t\tsetNotificacionLeida: (parent, args, {models})=>{\n\t\t\tmodels.Notificacion.update({_id: args.idNotificacion, tipo: args.tipo},{$set: {leido: true}},{upsert: true, new: true})\n\t\t\t\t.then(documento => documento)\n\t\t\t\t.catch(error => error);\n\t\t}\n\t}\n};"]}